<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splitify</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Syne:wght@700;800&display=swap');

    :root {
      --bg: #0d0d0d;
      --bg2: #141414;
      --bg3: #1e1e1e;
      --bg4: #272727;
      --border: #2e2e2e;
      --border2: #3d3d3d;
      --accent: #b8f2a0;
      --accent2: #78e860;
      --accent-dim: rgba(184, 242, 160, 0.13);
      --accent-dim2: rgba(184, 242, 160, 0.07);
      --red: #ff5c5c;
      --red-dim: rgba(255, 92, 92, 0.13);
      --yellow: #f0c040;
      --text: #f5f5f5;
      --text2: #c8c8c8;
      --text3: #848484;
      --mono: 'IBM Plex Mono', monospace;
      --sans: 'Syne', sans-serif;
      --radius: 6px;
      --tr: 0.15s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 500;
      line-height: 1.5;
      overflow: hidden;
      user-select: none;
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ‚îÄ‚îÄ Titlebar ‚îÄ‚îÄ */
    #titlebar {
      display: flex;
      align-items: center;
      padding: 0 16px;
      height: 46px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      -webkit-app-region: drag;
      gap: 10px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 9px;
      -webkit-app-region: no-drag;
    }

    .logo-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 14px;
      height: 14px;
    }

    .logo-name {
      font-family: var(--sans);
      font-weight: 800;
      font-size: 17px;
      letter-spacing: -0.3px;
    }

    .logo-version {
      font-size: 10px;
      color: var(--text3);
      margin-top: 1px;
      font-weight: 400;
    }

    /* ‚îÄ‚îÄ Update Banner ‚îÄ‚îÄ */
    #update-banner {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: rgba(184, 242, 160, 0.08);
      border-bottom: 1px solid rgba(184, 242, 160, 0.2);
      flex-shrink: 0;
    }

    #update-banner.visible {
      display: flex;
    }

    #update-banner .ub-text {
      flex: 1;
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
    }

    #update-banner .ub-progress {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 4px;
    }

    #update-banner .ub-bar {
      height: 100%;
      background: var(--accent2);
      border-radius: 2px;
      transition: width 0.3s;
      width: 0%;
    }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    #tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      padding: 0 16px;
      flex-shrink: 0;
      -webkit-app-region: no-drag;
    }

    .tab {
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text3);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color var(--tr);
    }

    .tab:hover {
      color: var(--text2);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* ‚îÄ‚îÄ Tab Panels ‚îÄ‚îÄ */
    .tab-panel {
      display: none;
      flex: 1;
      overflow: hidden;
      flex-direction: column;
    }

    .tab-panel.active {
      display: flex;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      cursor: pointer;
      border-radius: var(--radius);
      border: 1px solid var(--border2);
      background: var(--bg3);
      color: var(--text2);
      transition: all var(--tr);
      white-space: nowrap;
      text-transform: uppercase;
    }

    .btn:hover {
      background: var(--bg4);
      color: var(--text);
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-accent {
      background: var(--accent-dim);
      color: var(--accent);
      border-color: rgba(184, 242, 160, 0.25);
    }

    .btn-accent:hover {
      background: rgba(184, 242, 160, 0.2);
      color: var(--accent2);
      border-color: var(--accent);
    }

    .btn-danger {
      background: var(--red-dim);
      color: var(--red);
      border-color: rgba(255, 92, 92, 0.2);
    }

    .btn-danger:hover {
      background: rgba(255, 92, 92, 0.2);
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
      color: var(--text3);
    }

    .btn-ghost:hover {
      background: var(--bg3);
      color: var(--text2);
      border-color: var(--border);
    }

    /* ‚îÄ‚îÄ Inputs / Selects ‚îÄ‚îÄ */
    .field-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      padding: 8px 11px;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 500;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      outline: none;
      transition: border-color var(--tr);
    }

    .input:focus {
      border-color: var(--accent);
    }

    .input::placeholder {
      color: var(--text3);
      font-weight: 400;
    }

    .select-wrap {
      position: relative;
    }

    .select {
      width: 100%;
      padding: 8px 28px 8px 11px;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 500;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      outline: none;
      appearance: none;
      cursor: pointer;
      transition: border-color var(--tr);
    }

    .select:focus {
      border-color: var(--accent);
    }

    .select-wrap::after {
      content: '‚ñæ';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text3);
      pointer-events: none;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--text2);
    }

    .checkbox-label input[type=checkbox] {
      accent-color: var(--accent2);
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SPLIT TAB
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #split-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Split layout ‚îÄ‚îÄ */
    #split-top {
      padding: 14px 16px 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex-shrink: 0;
    }

    #split-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding-bottom: 8px;
    }

    #split-bottom {
      padding: 10px 16px 12px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
    #drop-zone {
      border: 1.5px dashed var(--border2);
      border-radius: 8px;
      padding: 18px 16px;
      text-align: center;
      cursor: pointer;
      transition: all var(--tr);
      background: var(--bg2);
    }

    #drop-zone:hover,
    #drop-zone.drag-over {
      border-color: var(--accent);
      background: var(--accent-dim2);
    }

    #drop-zone .drop-icon {
      font-size: 22px;
      margin-bottom: 6px;
      opacity: 0.5;
    }

    #drop-zone .drop-text {
      font-family: var(--sans);
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 3px;
    }

    #drop-zone .drop-sub {
      font-size: 11px;
      color: var(--text3);
      font-weight: 400;
    }

    /* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
    .section {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .section-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text3);
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ‚îÄ‚îÄ Two-column layout ‚îÄ‚îÄ */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* ‚îÄ‚îÄ Queue ‚îÄ‚îÄ */
    #queue-section {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    #queue-section.visible {
      display: flex;
    }

    .queue-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .queue-header .q-count {
      flex: 1;
      font-size: 11px;
      color: var(--text3);
      font-weight: 600;
    }

    #queue-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .queue-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color var(--tr);
    }

    .queue-item.selected {
      border-color: var(--border2);
    }

    .queue-item.deselected {
      opacity: 0.5;
    }

    .queue-item.processing {
      border-color: var(--accent);
      background: var(--accent-dim2);
    }

    .queue-item.done {
      border-color: rgba(120, 232, 96, 0.3);
    }

    .queue-item.error {
      border-color: rgba(255, 92, 92, 0.4);
      background: var(--red-dim);
    }

    .qi-main {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 9px 12px;
    }

    .qi-check {
      flex-shrink: 0;
      accent-color: var(--accent2);
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    .qi-info {
      flex: 1;
      min-width: 0;
    }

    .qi-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .qi-status {
      font-size: 11px;
      font-weight: 400;
      margin-top: 2px;
    }

    .qi-status.s-waiting {
      color: var(--text3);
    }

    .qi-status.s-analyzing {
      color: var(--yellow);
    }

    .qi-status.s-ready {
      color: var(--accent2);
    }

    .qi-status.s-processing {
      color: var(--accent);
    }

    .qi-status.s-done {
      color: var(--accent2);
    }

    .qi-status.s-error {
      color: var(--red);
    }

    .qi-status.s-skipped {
      color: var(--text3);
    }

    .qi-remove {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 15px;
      padding: 0 2px;
      transition: color var(--tr);
      flex-shrink: 0;
    }

    .qi-remove:hover {
      color: var(--red);
    }

    /* Preview rows */
    .qi-previews {
      padding: 0 12px 9px 35px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .preview-pill {
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      background: var(--accent-dim);
      color: var(--accent2);
      border: 1px solid rgba(120, 232, 96, 0.2);
      white-space: nowrap;
    }

    .preview-pill.excl {
      background: var(--red-dim);
      color: #ff7a7a;
      border-color: rgba(255, 92, 92, 0.2);
    }

    /* ‚îÄ‚îÄ Output / Options ‚îÄ‚îÄ */
    .output-row {
      display: flex;
      gap: 7px;
      align-items: center;
    }

    .output-path {
      flex: 1;
      padding: 8px 11px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 400;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text2);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Split Button ‚îÄ‚îÄ */
    #split-btn {
      width: 100%;
      padding: 13px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 1.5px;
      background: var(--accent-dim);
      color: var(--accent);
      border: 1.5px solid rgba(184, 242, 160, 0.3);
      border-radius: var(--radius);
      font-family: var(--mono);
      cursor: pointer;
      transition: all var(--tr);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 9px;
    }

    #split-btn:hover:not(:disabled) {
      background: rgba(184, 242, 160, 0.2);
      border-color: var(--accent);
    }

    #split-btn:active:not(:disabled) {
      transform: scale(0.99);
    }

    #split-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* ‚îÄ‚îÄ Log ‚îÄ‚îÄ */
    #log-area {
      display: none;
      flex-direction: column;
      gap: 3px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
    }

    #log-area.visible {
      display: flex;
    }

    .log-line {
      font-size: 11px;
      font-weight: 500;
      line-height: 1.5;
      display: flex;
      gap: 8px;
    }

    .log-time {
      color: var(--text3);
      flex-shrink: 0;
      font-weight: 400;
    }

    .log-msg {
      color: var(--text2);
    }

    .log-ok .log-msg {
      color: var(--accent2);
    }

    .log-err .log-msg {
      color: var(--red);
    }

    .log-warn .log-msg {
      color: var(--yellow);
    }

    .log-head {
      color: var(--text);
      font-weight: 700;
    }

    .log-result-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--accent-dim2);
      border: 1px solid rgba(184, 242, 160, 0.15);
      border-radius: var(--radius);
      margin-top: 2px;
    }

    .log-result-bar span {
      font-size: 12px;
      color: var(--accent);
      font-weight: 700;
    }

    /* ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ */
    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(184, 242, 160, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PROFILES TAB
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #profiles-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-toolbar {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .panel-toolbar span {
      flex: 1;
      font-size: 11px;
      font-weight: 700;
      color: var(--text3);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    #profile-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .profile-item {
      display: flex;
      align-items: center;
      padding: 11px 13px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      cursor: pointer;
      transition: all var(--tr);
      gap: 10px;
    }

    .profile-item:hover {
      background: var(--bg3);
      border-color: var(--border2);
    }

    .profile-item.selected {
      border-color: var(--accent);
      background: var(--accent-dim2);
    }

    .profile-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }

    .profile-info {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-family: var(--sans);
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-meta {
      font-size: 11px;
      font-weight: 400;
      color: var(--text3);
      margin-top: 2px;
    }

    .profile-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity var(--tr);
    }

    .profile-item:hover .profile-actions {
      opacity: 1;
    }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 40px 16px;
      color: var(--text3);
    }

    .empty-state .es-icon {
      font-size: 30px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .empty-state .es-text {
      font-size: 12px;
      line-height: 1.7;
      font-weight: 400;
    }

    /* ‚îÄ‚îÄ Editor Modal ‚îÄ‚îÄ */
    #editor-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #editor-modal-overlay.open {
      display: flex;
    }

    #editor-modal {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      max-height: calc(100vh - 60px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
    }

    .em-header {
      display: flex;
      align-items: center;
      padding: 16px 18px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      gap: 10px;
    }

    .em-title {
      font-family: var(--sans);
      font-weight: 800;
      font-size: 17px;
      flex: 1;
      color: var(--text);
    }

    .em-body {
      padding: 16px 18px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }

    .em-footer {
      padding: 12px 18px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Param list ‚îÄ‚îÄ */
    .params-header {
      display: flex;
      align-items: center;
      margin-bottom: 7px;
      gap: 8px;
    }

    .params-header-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text3);
      flex: 1;
    }

    #param-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .param-row {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 6px 9px;
      background: var(--bg2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .param-value {
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .param-label {
      font-size: 11px;
      font-weight: 400;
      color: var(--text3);
      min-width: 50px;
      text-align: right;
    }

    .param-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.3px;
      padding: 2px 7px;
      border-radius: 3px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all var(--tr);
    }

    .param-badge.incl {
      background: rgba(120, 232, 96, 0.15);
      color: var(--accent2);
      border: 1px solid rgba(120, 232, 96, 0.25);
    }

    .param-badge.excl {
      background: var(--red-dim);
      color: #ff7a7a;
      border: 1px solid rgba(255, 92, 92, 0.2);
    }

    .param-badge:hover {
      filter: brightness(1.2);
    }

    .param-del {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 15px;
      line-height: 1;
      padding: 0 2px;
      transition: color var(--tr);
      flex-shrink: 0;
    }

    .param-del:hover {
      color: var(--red);
    }

    .add-param-row {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    /* ‚îÄ‚îÄ Import Modal ‚îÄ‚îÄ */
    #modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }

    #modal-overlay.open {
      display: flex;
    }

    #modal {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 10px;
      width: 340px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 14px 16px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-title {
      font-family: var(--sans);
      font-weight: 700;
      font-size: 15px;
      flex: 1;
    }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }

    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETTINGS TAB
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #settings-panel {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .settings-section {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: visible;
      width: 100%;
    }

    .settings-section-title:first-child {
      border-radius: 8px 8px 0 0;
    }

    .settings-section-title {
      padding: 8px 14px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text3);
      border-bottom: 1px solid var(--border);
      background: var(--bg3);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
      min-height: 48px;
      flex-wrap: wrap;
    }

    .settings-row:last-child {
      border-bottom: none;
    }

    .settings-row-info {
      flex: 1;
      min-width: 0;
    }

    .settings-row-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .settings-row-sub {
      font-size: 11px;
      font-weight: 400;
      color: var(--text3);
      line-height: 1.4;
    }

    .settings-row-right {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      overflow: visible;
    }

    /* Toggle switch */
    .toggle {
      position: relative;
      width: 42px;
      height: 24px;
      flex-shrink: 0;
      cursor: pointer;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--bg4);
      border: 1px solid var(--border2);
      border-radius: 24px;
      transition: all var(--tr);
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      left: 3px;
      top: 3px;
      background: var(--text3);
      border-radius: 50%;
      transition: all var(--tr);
    }

    .toggle input:checked+.toggle-slider {
      background: var(--accent-dim);
      border-color: var(--accent2);
    }

    .toggle input:checked+.toggle-slider::before {
      transform: translateX(18px);
      background: var(--accent2);
    }

    /* Theme switcher */
    .theme-switcher {
      display: flex;
      gap: 4px;
    }

    .theme-btn {
      padding: 6px 14px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      border-radius: var(--radius);
      border: 1px solid var(--border2);
      background: var(--bg3);
      color: var(--text3);
      transition: all var(--tr);
      white-space: nowrap;
    }

    .theme-btn.active {
      background: var(--accent-dim);
      color: var(--accent);
      border-color: rgba(184, 242, 160, 0.3);
    }

    .theme-btn:hover:not(.active) {
      background: var(--bg4);
      color: var(--text2);
    }

    /* ‚îÄ‚îÄ Light theme overrides ‚îÄ‚îÄ */
    body.light {
      --bg: #f5f5f5;
      --bg2: #ffffff;
      --bg3: #eeeeee;
      --bg4: #e4e4e4;
      --border: #d0d0d0;
      --border2: #bbbbbb;
      --text: #1a1a1a;
      --text2: #444444;
      --text3: #888888;
      --accent-dim: rgba(60, 160, 40, 0.12);
      --accent-dim2: rgba(60, 160, 40, 0.06);
      --accent: #2d8a1e;
      --accent2: #1e6e12;
      --red-dim: rgba(200, 40, 40, 0.1);
    }

  /* ‚ïê‚ïê History Tab ‚ïê‚ïê */
  #history-panel { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  .history-toolbar { padding:10px 16px 8px; display:flex; align-items:center; border-bottom:1px solid var(--border); flex-shrink:0; }
  #history-list { flex:1; overflow-y:auto; padding:8px 12px 12px; display:flex; flex-direction:column; gap:8px; }
  .history-item { background:var(--bg2); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .history-item-header { display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; }
  .history-item-header:hover { background:var(--bg3); }
  .history-chevron { font-size:10px; color:var(--text3); transition:transform var(--tr); flex-shrink:0; }
  .history-item.open .history-chevron { transform:rotate(90deg); }
  .history-item-title { flex:1; min-width:0; }
  .history-item-name { font-size:12px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .history-item-meta { font-size:10px; color:var(--text3); font-weight:400; margin-top:1px; }
  .history-item-body { display:none; padding:0 12px 10px; }
  .history-item.open .history-item-body { display:block; }
  .history-files { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px; }
  .history-file-pill { font-size:10px; font-weight:500; color:var(--text2); background:var(--bg3); border:1px solid var(--border); border-radius:4px; padding:2px 7px; }

  /* ‚ïê‚ïê Changelog entries ‚ïê‚ïê */
  .changelog-entry { margin-bottom:18px; padding-bottom:18px; border-bottom:1px solid var(--border); }
  .changelog-entry:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
  .changelog-version { font-size:11px; font-weight:700; color:var(--accent); letter-spacing:0.5px; text-transform:uppercase; margin-bottom:4px; }
  .changelog-date { font-size:10px; color:var(--text3); margin-bottom:8px; }
  .changelog-notes { font-size:12px; color:var(--text2); line-height:1.7; font-weight:400; white-space:pre-wrap; }

  </style>
</head>

<body>
  <div id="app">

    <!-- Titlebar -->
    <div id="titlebar">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 13 13" fill="none">
            <rect x="0.5" y="0.5" width="5" height="5" rx="1" fill="#0d0d0d" />
            <rect x="7.5" y="0.5" width="5" height="5" rx="1" fill="#0d0d0d" />
            <rect x="0.5" y="7.5" width="5" height="5" rx="1" fill="#0d0d0d" />
            <rect x="7.5" y="7.5" width="5" height="5" rx="1" fill="#0d0d0d" opacity="0.4" />
            <path d="M9.5 9.5L12 12M9.5 12L12 9.5" stroke="#0d0d0d" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </div>
        <div>
          <div class="logo-name">Splitify</div>
          <div style="display:flex;align-items:center;gap:6px">
            <div class="logo-version" id="app-version">v1.0.0</div>
            <div class="logo-version">by VSL software</div>
          </div>
        </div>
      </div>
      <button id="changelog-btn" title="Patch Notes" style="margin-left:auto;-webkit-app-region:no-drag;background:none;border:1px solid var(--border2);border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text3);font-size:13px;font-weight:700;font-family:var(--mono);transition:all var(--tr);flex-shrink:0">?</button>
    </div>

    <!-- Update Banner -->
    <div id="update-banner">
      <div style="font-size:14px;flex-shrink:0">‚Üë</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="ub-text" id="ub-text">Update available</div>
          <button id="ub-notes-toggle" style="display:none;background:none;border:none;cursor:pointer;font-size:10px;font-weight:700;color:var(--accent2);font-family:var(--mono);padding:0;letter-spacing:0.5px">WHAT'S NEW ‚ñæ</button>
        </div>
        <div id="ub-notes" style="display:none;margin-top:5px;font-size:11px;color:var(--text2);line-height:1.6;font-weight:400;padding:6px 8px;background:rgba(184,242,160,0.05);border-radius:4px;border:1px solid rgba(184,242,160,0.1)"></div>
        <div id="ub-progress-wrap" style="display:none">
          <div class="ub-progress"><div class="ub-bar" id="ub-bar"></div></div>
        </div>
      </div>
      <button class="btn btn-accent" id="ub-btn" style="display:none">Restart & Install</button>
    </div>

    <!-- Tabs -->
    <div id="tabs">
      <div class="tab active" data-tab="split">‚ö° Split File</div>
      <div class="tab" data-tab="profiles">‚óà Profiles</div>
      <div class="tab" data-tab="settings">‚öô Settings</div>
      <div class="tab" data-tab="history">‚ó∑ History</div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPLIT TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="tab-split" class="tab-panel active">
      <div id="split-panel">

        <!-- TOP: always visible, not scrollable -->
        <div id="split-top">
          <!-- Drop Zone -->
          <div id="drop-zone">
            <div class="drop-icon">üìÇ</div>
            <div class="drop-text">Drop Excel files here</div>
            <div class="drop-sub">or click to browse ¬∑ .xlsx ¬∑ .xls ¬∑ .csv ¬∑ multiple files supported</div>
          </div>
          <input type="file" id="file-input" accept=".xlsx,.xls,.csv" multiple style="display:none">

          <!-- Column + Profile -->
          <div class="two-col" id="section-settings" style="display:none">
            <div class="section">
              <div class="section-title">Split Column</div>
              <div class="select-wrap">
                <select class="select" id="column-select">
                  <option value="">‚Äî select column ‚Äî</option>
                </select>
              </div>
              <div id="column-samples" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px"></div>
            </div>
            <div class="section">
              <div class="section-title">Profile</div>
              <div class="select-wrap">
                <select class="select" id="profile-select">
                  <option value="">‚Äî no profile ‚Äî</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- MIDDLE: scrollable queue -->
        <div id="split-scroll">
          <!-- Queue -->
          <div id="queue-section">
            <div class="section-title">File Queue</div>
            <div class="queue-header">
              <label class="checkbox-label" style="gap:8px">
                <input type="checkbox" id="select-all-cb"> <span
                  style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">Select All</span>
              </label>
              <span class="q-count" id="q-count">0 files</span>
              <button class="btn btn-ghost" id="clear-done-btn" style="font-size:10px;padding:4px 8px">Clear
                Done</button>
            </div>
            <div id="queue-list"></div>
          </div>

          <!-- Log -->
          <div id="log-area"></div>
        </div>

        <!-- BOTTOM: always visible, sticky -->
        <div id="split-bottom" style="display:none">
          <!-- Output Folder -->
          <div class="section" id="section-output">
            <div class="section-title">Output Folder</div>
            <div class="output-row">
              <div class="output-path" id="output-path-display">Same folder as each input file</div>
              <button class="btn" id="browse-output-btn">Browse</button>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:7px;margin-top:4px">
              <label class="checkbox-label">
                <input type="checkbox" id="keep-nonmatching"> Export non-matching rows to separate file
              </label>
              <div style="display:flex;align-items:center;gap:8px;flex:1">
                <label class="checkbox-label">
                  <input type="checkbox" id="custom-prefix-toggle"> Custom prefix
                </label>
                <input class="input" id="custom-prefix" placeholder="leave blank to use original filename"
                  style="display:none;flex:1;font-size:11px;padding:6px 9px">
              </div>
            </div>
          </div>

          <!-- Split Button -->
          <button id="split-btn" disabled>
            <span id="split-btn-icon">‚ñ∂</span>
            <span id="split-btn-text">SPLIT SELECTED FILES</span>
          </button>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILES TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="tab-profiles" class="tab-panel">
      <div id="profiles-panel">
        <div class="panel-toolbar">
          <span>Manage Profiles</span>
          <button class="btn btn-accent" id="new-profile-btn">+ New Profile</button>
        </div>
        <div id="profile-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="tab-settings" class="tab-panel">
      <div id="settings-panel">

        <!-- Updates section -->
        <div class="settings-section">
          <div class="settings-section-title">Updates</div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Current Version</div>
              <div class="settings-row-sub" id="settings-version">v‚Äî</div>
            </div>
            <div class="settings-row-right"><button class="btn btn-accent" id="check-updates-btn">Check Now</button>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Check on startup</div>
              <div class="settings-row-sub">Automatically check when app launches</div>
            </div>
            <div class="settings-row-right"><label class="toggle">
                <input type="checkbox" id="setting-startup-check" checked>
                <span class="toggle-slider"></span>
              </label></div>
          </div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Periodic check interval</div>
              <div class="settings-row-sub">How often to check while app is open</div>
            </div>
            <div class="settings-row-right">
              <div class="select-wrap" style="width:130px">
                <select class="select" id="setting-interval" style="font-size:12px">
                  <option value="1">Every hour</option>
                  <option value="2">Every 2 hours</option>
                  <option value="4" selected>Every 4 hours</option>
                  <option value="8">Every 8 hours</option>
                  <option value="24">Once a day</option>
                </select>
              </div>
            </div>
          </div>

          <div class="settings-row" id="update-status-row" style="display:none">
            <div class="settings-row-info">
              <div class="settings-row-label" id="update-status-label">Checking...</div>
            </div>
          </div>
        </div>

        <!-- Appearance section -->
        <div class="settings-section">
          <div class="settings-section-title">Appearance</div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Theme</div>
              <div class="settings-row-sub">Switch between dark and light mode</div>
            </div>
            <div class="settings-row-right">
              <div class="theme-switcher">
                <button class="theme-btn active" id="theme-dark" data-theme="dark">‚óë Dark</button>
                <button class="theme-btn" id="theme-light" data-theme="light">‚óã Light</button>
              </div>
            </div>
          </div>
        </div>

<!-- Help section -->
        <div class="settings-section">
          <div class="settings-section-title">Help</div>
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Show Tutorial Again</div>
              <div class="settings-row-sub">Replay the first-time walkthrough</div>
            </div>
            <div class="settings-row-right">
              <button class="btn btn-ghost" id="show-tutorial-btn">Show Tutorial</button>
            </div>
          </div>
        </div>

<!-- Import / Export Profiles -->
        <div class="settings-section">
          <div class="settings-section-title">Profiles ‚Äî Import / Export</div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Export All Profiles</div>
              <div class="settings-row-sub">Save all profiles to a .json backup file</div>
            </div>
            <div class="settings-row-right"><button class="btn btn-accent" id="export-profiles-btn">Export ‚Üì</button>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Import Profiles</div>
              <div class="settings-row-sub">Load profiles from a .json backup file</div>
            </div>
            <div class="settings-row-right">
              <select class="select" id="import-mode" style="width:110px;font-size:11px">
                <option value="merge">Merge</option>
                <option value="replace">Replace all</option>
              </select>
              <button class="btn btn-accent" id="import-profiles-btn">Import ‚Üë</button>
            </div>
          </div>
          <input type="file" id="import-profiles-input" accept=".json" style="display:none">
        </div>

        <!-- Feedback section -->
        <div class="settings-section">
          <div class="settings-section-title">Feedback</div>
          <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:10px">
            <div class="settings-row-sub" style="font-size:12px;color:var(--text2)">
              Found a bug or have a suggestion? Send feedback directly.
            </div>
            <textarea class="input" id="feedback-text" rows="4"
              placeholder="Describe your feedback, bug report, or feature request..."
              style="resize:vertical;font-size:12px;line-height:1.6;font-weight:400"></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-ghost" id="feedback-github-btn">Open GitHub Issue ‚Üó</button>
              <button class="btn btn-accent" id="feedback-email-btn">Send via Email</button>
            </div>
          </div>
        </div>

        <!-- About section -->
        <div class="settings-section">
          <div class="settings-section-title">About</div>
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">VSL Splitify</div>
              <div class="settings-row-sub">Excel file splitter with profile management</div>
            </div>
            <div class="settings-row-right"><span
                style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.5px;text-transform:uppercase">VSL
                SOFTWARE</span></div>
          </div>
          <div class="settings-row">
            <div class="settings-row-info">
              <div class="settings-row-label">Source Code</div>
              <div class="settings-row-sub">github.com/vslnnd/Splitify</div>
            </div>
            <div class="settings-row-right"><button class="btn btn-ghost" id="github-btn">View ‚Üó</button></div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-history" class="tab-panel">
    <div id="history-panel">
      <div class="history-toolbar">
        <span id="history-count" style="font-size:11px;color:var(--text3);font-weight:600"></span>
        <button class="btn btn-ghost" id="clear-history-btn" style="font-size:10px;padding:4px 9px;margin-left:auto">Clear All</button>
      </div>
      <div id="history-list"></div>
      <div id="history-empty" style="display:none">
        <div class="empty-state">
          <div class="es-icon">‚ó∑</div>
          <div class="es-text">No split history yet.<br>Your completed splits will appear here.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TUTORIAL OVERLAY ‚ïê‚ïê‚ïê‚ïê -->
  <div id="tutorial-overlay" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.75);backdrop-filter:blur(2px)">
    <div id="tutorial-spotlight" style="display:none;position:fixed;border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,0.75);border:2px solid var(--accent);transition:all 0.3s ease;pointer-events:none;z-index:10001"></div>
    <div id="tutorial-card" style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--accent);border-radius:10px;padding:16px 18px;width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:10002">
      <div id="tutorial-step-indicator" style="font-size:10px;color:var(--text3);font-weight:700;letter-spacing:0.5px;margin-bottom:6px;text-transform:uppercase"></div>
      <div id="tutorial-title" style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:6px"></div>
      <div id="tutorial-body" style="font-size:12px;color:var(--text2);line-height:1.6;font-weight:400;margin-bottom:14px"></div>
      <div id="tutorial-footer" style="display:flex;justify-content:space-between;align-items:center">
        <button class="btn btn-ghost" id="tutorial-skip-btn" style="font-size:11px">Skip Tutorial</button>
        <button class="btn btn-accent" id="tutorial-next-btn" style="font-size:11px">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê WHAT'S NEW MODAL ‚ïê‚ïê‚ïê‚ïê -->
  <div id="whatsnew-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9000;backdrop-filter:blur(4px)">
    <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:10px;width:90%;max-width:420px;display:flex;flex-direction:column;max-height:80vh;box-shadow:0 24px 60px rgba(0,0,0,0.5)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;flex-shrink:0">
        <span>üéâ What's New</span>
        <button id="whatsnew-close" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px 6px;border-radius:4px">‚úï</button>
      </div>
      <div style="flex:1;overflow-y:auto;padding:16px">
        <div id="whatsnew-version" style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase"></div>
        <div id="whatsnew-notes" style="font-size:12px;color:var(--text2);line-height:1.7;font-weight:400;white-space:pre-wrap"></div>
      </div>
      <div style="padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0">
        <button class="btn btn-accent" id="whatsnew-close-btn" style="width:100%;padding:10px">Got it!</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê CHANGELOG MODAL ‚ïê‚ïê‚ïê‚ïê -->
  <div id="changelog-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:9000;backdrop-filter:blur(4px)">
    <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:10px;width:90%;max-width:480px;display:flex;flex-direction:column;max-height:80vh;box-shadow:0 24px 60px rgba(0,0,0,0.5)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;flex-shrink:0">
        <span>üìã Patch Notes</span>
        <button id="changelog-close" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px 6px;border-radius:4px">‚úï</button>
      </div>
      <div id="changelog-body" style="flex:1;overflow-y:auto;padding:16px;max-height:420px"></div>
    </div>
  </div>

  <!-- Profile Editor Modal -->
  <div id="editor-modal-overlay">
    <div id="editor-modal">
      <div class="em-header">
        <span class="em-title" id="editor-title">Edit Profile</span>
        <button class="btn btn-ghost" id="editor-close-btn" style="padding:4px 8px;font-size:15px">‚úï</button>
      </div>
      <div class="em-body">
        <div>
          <div class="field-label">Profile Name</div>
          <input class="input" id="editor-name" placeholder="e.g. SElectric" maxlength="40">
        </div>
        <div>
          <div class="field-label">Description (optional)</div>
          <input class="input" id="editor-desc" placeholder="Short description..." maxlength="80">
        </div>
        <div>
          <div class="params-header">
            <span class="params-header-label">Parameters <span id="param-count"
                style="color:var(--text3);font-weight:400"></span></span>
            <button class="btn btn-ghost" id="import-btn" style="font-size:10px;padding:3px 9px">‚Üë Import</button>
          </div>
          <div id="param-list"></div>
          <div class="add-param-row">
            <input class="input" id="new-param-value" placeholder="Value  (e.g. 01, NAM, SOLAR)" style="flex:1">
            <input class="input" id="new-param-label" placeholder="Label" style="width:90px">
            <select class="select" id="new-param-payable" style="width:110px">
              <option value="1">Included</option>
              <option value="0">Exclude</option>
            </select>
            <button class="btn btn-accent" id="add-param-btn">‚úì Add</button>
          </div>
        </div>
      </div>
      <div class="em-footer">
        <button class="btn btn-accent" id="editor-save-btn" style="flex:1;padding:11px">‚úì Save Profile</button>
        <button class="btn btn-danger" id="editor-delete-btn" style="display:none;padding:11px 16px">Delete</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <div class="modal-header">
        <span class="modal-title">Import Parameters</span>
        <button class="btn btn-ghost" id="modal-close">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="font-size:12px;color:var(--text2);line-height:1.7;font-weight:400">
          One value per line. Optionally add a comma then a label.<br>
          Prefix with <code style="color:var(--accent);font-weight:700">!</code> to mark as <em>excluded</em>.<br><br>
          <span style="color:var(--text3)">Examples:<br>01<br>30, NAM<br>!131<br>!150, CN</span>
        </div>
        <div>
          <div class="field-label">Paste Values</div>
          <textarea class="input" id="import-textarea" rows="8"
            style="resize:vertical;font-size:12px;line-height:1.5;font-family:var(--mono);font-weight:400"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="modal-cancel">Cancel</button>
        <button class="btn btn-accent" id="modal-import">Import</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let profiles = [];
    let editingProfileId = null;
    let editingParams = [];
    let outputDir = null;

    // Queue: [{ id, path, name, selected, status, columns, samples, previews }]
    let queue = [];
    let isProcessing = false;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function init() {
      profiles = await window.splitify.getProfiles();
      renderProfileList();
      populateProfileSelect();
    }
    init();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const t = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(x => x.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + t).classList.add('active');
      });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FILE HANDLING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', async e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      for (const file of files) {
        const filePath = window.splitify.getFilePath(file);
        await addToQueue(filePath);
      }
    });

    fileInput.addEventListener('change', async () => {
      const files = Array.from(fileInput.files);
      for (const file of files) {
        const filePath = window.splitify.getFilePath(file);
        await addToQueue(filePath);
      }
      fileInput.value = '';
    });

    async function addToQueue(filePath) {
      if (!filePath) return;
      // Avoid duplicates
      if (queue.find(q => q.path === filePath)) return;

      const name = filePath.replace(/\\/g, '/').split('/').pop();
      const id = 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
      const item = { id, path: filePath, name, selected: true, status: 'waiting', columns: null, samples: null, previews: null };
      queue.push(item);

      showQueueSections();
      renderQueue();
      updateSplitBtn();

      // Analyze file to get columns
      item.status = 'analyzing';
      renderQueueItem(item);

      const info = await window.splitify.readFileColumns(filePath);
      if (info.error) {
        item.status = 'error';
        item.errorMsg = info.error;
      } else {
        item.columns = info.headers;
        item.samples = info.samples;
        item.totalRows = info.totalRows;
        item.status = 'ready';
        // Auto-populate column select if empty
        const colSel = document.getElementById('column-select');
        if (colSel.options.length <= 1) {
          populateColumnSelect(info.headers, info.samples);
        }
        // Auto-detect profile from client name column
        autoDetectProfile(info.headers, info.samples);
        computePreviews(item);
      }

      renderQueueItem(item);
      updateQueueCount();
      updateSplitBtn();
    }

    function computePreviews(item) {
      const colIdx = parseInt(document.getElementById('column-select').value);
      const profileId = document.getElementById('profile-select').value;
      const profile = profiles.find(p => p.id === profileId);
      if (isNaN(colIdx) || !profile || !item.samples) { item.previews = null; return; }

      const today = new Date();
      const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
      const customPfx = document.getElementById('custom-prefix-toggle').checked ? document.getElementById('custom-prefix').value.trim() : '';
      const base = customPfx || item.name.replace(/\.[^.]+$/, '');

      // Build region map
      const regionMap = new Map();
      const excluded = [];
      profile.parameters.forEach(p => {
        if (p.payable) {
          const key = (p.label && p.label.trim()) ? p.label.trim() : p.value;
          if (!regionMap.has(key)) regionMap.set(key, []);
          regionMap.get(key).push(p.value);
        } else {
          excluded.push(p.value);
        }
      });

      item.previews = {
        regions: Array.from(regionMap.keys()).map(r => `${dateStr}_${base}_${r}.xlsx`),
        excluded: excluded
      };
    }

    function recomputeAllPreviews() {
      queue.forEach(item => {
        if (item.status === 'ready' || item.status === 'done') computePreviews(item);
      });
      renderQueue();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  COLUMN / PROFILE SELECTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function populateColumnSelect(headers, samples) {
      const sel = document.getElementById('column-select');
      sel.innerHTML = '<option value="">‚Äî select column ‚Äî</option>';
      headers.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.index;
        opt.textContent = h.name;
        sel.appendChild(opt);
      });
      // Auto-select cost center column
      const ccIdx = headers.findIndex(h => /cost.?cent|cc\b/i.test(h.name));
      if (ccIdx !== -1) {
        sel.value = headers[ccIdx].index;
        showColumnSamples(headers[ccIdx].index, samples);
        recomputeAllPreviews();
      }
    }

    // Auto-detect profile based on client name column values
    function autoDetectProfile(headers, samples) {
      // Only auto-detect if no profile is already selected
      const profileSel = document.getElementById('profile-select');
      if (profileSel.value) return; // already chosen, don't override

      // Find a "client" column
      const clientColIdx = headers.findIndex(h =>
        /^client(\s*name)?$|^client\s*$/i.test(h.name.trim())
      );
      if (clientColIdx === -1) return;

      // Get unique values from that column
      const vals = (samples[clientColIdx] || []).map(v => String(v).trim().toLowerCase());
      if (!vals.length) return;

      // Try to match any profile name against these values
      const matched = profiles.find(p =>
        vals.some(v => v === p.name.trim().toLowerCase())
      );

      if (matched) {
        profileSel.value = matched.id;
        // Show a subtle indicator in the profile select
        profileSel.style.borderColor = 'var(--accent)';
        setTimeout(() => { profileSel.style.borderColor = ''; }, 2500);
        recomputeAllPreviews();
        updateSplitBtn();
      }
    }

    document.getElementById('column-select').addEventListener('change', function () {
      const idx = this.value;
      const firstItem = queue.find(q => q.samples);
      if (idx !== '' && firstItem) showColumnSamples(parseInt(idx), firstItem.samples);
      else document.getElementById('column-samples').innerHTML = '';
      recomputeAllPreviews();
      updateSplitBtn();
    });

    document.getElementById('profile-select').addEventListener('change', () => {
      recomputeAllPreviews();
      updateSplitBtn();
    });

    function showColumnSamples(idx, samples) {
      const el = document.getElementById('column-samples');
      const vals = (samples && samples[idx]) || [];
      el.innerHTML = vals.map(v => `<span style="padding:2px 7px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;font-size:10px;color:var(--text2)">${escHtml(String(v))}</span>`).join('');
    }

    function populateProfileSelect() {
      const sel = document.getElementById('profile-select');
      const cur = sel.value;
      sel.innerHTML = '<option value="">‚Äî no profile ‚Äî</option>';
      profiles.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
      });
      if (cur) sel.value = cur;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  QUEUE RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showQueueSections() {
      document.getElementById('section-settings').style.display = '';
      document.getElementById('queue-section').classList.add('visible');
      document.getElementById('split-bottom').style.display = '';
    }

    function renderQueue() {
      queue.forEach(item => renderQueueItem(item));
      updateQueueCount();
    }

    function renderQueueItem(item) {
      const list = document.getElementById('queue-list');
      let el = document.getElementById('qi-' + item.id);
      const html = buildQueueItemHTML(item);

      if (!el) {
        el = document.createElement('div');
        el.id = 'qi-' + item.id;
        el.className = 'queue-item';
        list.appendChild(el);
      }

      el.className = `queue-item ${item.status === 'processing' ? 'processing' : item.status === 'done' ? 'done' : item.status === 'error' ? 'error' : item.selected ? 'selected' : 'deselected'}`;
      el.innerHTML = html;

      // Checkbox listener
      const cb = el.querySelector('.qi-check');
      if (cb) cb.addEventListener('change', () => {
        item.selected = cb.checked;
        el.className = `queue-item ${item.selected ? 'selected' : 'deselected'}`;
        updateSelectAll();
        updateSplitBtn();
      });

      // Remove button
      const rm = el.querySelector('.qi-remove');
      if (rm) rm.addEventListener('click', () => {
        queue = queue.filter(q => q.id !== item.id);
        el.remove();
        updateQueueCount();
        updateSelectAll();
        updateSplitBtn();
        if (queue.length === 0) hideSections();
      });
    }

    function buildQueueItemHTML(item) {
      const statusMap = {
        waiting: { cls: 's-waiting', text: 'Waiting...' },
        analyzing: { cls: 's-analyzing', text: 'Analyzing...' },
        ready: { cls: 's-ready', text: item.totalRows ? `${item.totalRows} rows ¬∑ ready` : 'Ready' },
        processing: { cls: 's-processing', text: 'Splitting...' },
        done: { cls: 's-done', text: 'Done ‚úì' },
        error: { cls: 's-error', text: `Error: ${item.errorMsg || 'unknown'}` },
        skipped: { cls: 's-skipped', text: 'Skipped' },
      };
      const s = statusMap[item.status] || statusMap.waiting;
      const spinnerHtml = item.status === 'analyzing' || item.status === 'processing'
        ? '<div class="spinner" style="margin-left:4px"></div>' : '';

      let previewsHtml = '';
      if (item.previews && item.previews.regions.length) {
        previewsHtml = `<div class="qi-previews">
      ${item.previews.regions.map(f => `<span class="preview-pill" title="${escHtml(f)}">${escHtml(f)}</span>`).join('')}
    </div>`;
      }

      return `<div class="qi-main">
    <input type="checkbox" class="qi-check" ${item.selected ? 'checked' : ''} ${item.status === 'processing' || item.status === 'done' ? 'disabled' : ''}>
    <div class="qi-info">
      <div class="qi-name">${escHtml(item.name)}</div>
      <div class="qi-status ${s.cls}" style="display:flex;align-items:center;gap:5px">${escHtml(s.text)}${spinnerHtml}</div>
    </div>
    <button class="qi-remove" title="Remove" ${item.status === 'processing' ? 'disabled' : ''}>√ó</button>
  </div>${previewsHtml}`;
    }

    function updateQueueCount() {
      const sel = queue.filter(q => q.selected).length;
      document.getElementById('q-count').textContent = `${queue.length} file${queue.length !== 1 ? 's' : ''} ¬∑ ${sel} selected`;
    }

    function updateSelectAll() {
      const cb = document.getElementById('select-all-cb');
      const selectable = queue.filter(q => q.status !== 'processing' && q.status !== 'done');
      cb.checked = selectable.length > 0 && selectable.every(q => q.selected);
      cb.indeterminate = selectable.some(q => q.selected) && !selectable.every(q => q.selected);
    }

    document.getElementById('select-all-cb').addEventListener('change', function () {
      queue.forEach(item => {
        if (item.status !== 'processing' && item.status !== 'done') {
          item.selected = this.checked;
        }
      });
      renderQueue();
      updateQueueCount();
      updateSplitBtn();
    });

    document.getElementById('clear-done-btn').addEventListener('click', () => {
      queue = queue.filter(q => q.status !== 'done');
      document.getElementById('queue-list').innerHTML = '';
      queue.forEach(item => renderQueueItem(item));
      updateQueueCount();
      updateSelectAll();
      updateSplitBtn();
      if (queue.length === 0) hideSections();
    });

    function hideSections() {
      document.getElementById('section-settings').style.display = 'none';
      document.getElementById('queue-section').classList.remove('visible');
      document.getElementById('split-bottom').style.display = 'none';
      document.getElementById('log-area').classList.remove('visible');
      document.getElementById('column-select').innerHTML = '<option value="">‚Äî select column ‚Äî</option>';
      document.getElementById('column-samples').innerHTML = '';
    }

    function updateSplitBtn() {
      const btn = document.getElementById('split-btn');
      const colSel = document.getElementById('column-select');
      const hasSelected = queue.some(q => q.selected && (q.status === 'ready' || q.status === 'waiting'));
      btn.disabled = !hasSelected || colSel.value === '' || isProcessing;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  OUTPUT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('browse-output-btn').addEventListener('click', async () => {
      const folder = await window.splitify.pickFolder();
      if (folder) {
        outputDir = folder;
        const d = document.getElementById('output-path-display');
        d.textContent = folder; d.title = folder;
      }
    });

    document.getElementById('custom-prefix-toggle').addEventListener('change', function () {
      const inp = document.getElementById('custom-prefix');
      inp.style.display = this.checked ? '' : 'none';
      if (this.checked) inp.focus();
      recomputeAllPreviews();
    });

    document.getElementById('custom-prefix').addEventListener('input', recomputeAllPreviews);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SPLIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('split-btn').addEventListener('click', doSplitQueue);

    async function doSplitQueue() {
      if (isProcessing) return;
      isProcessing = true;

      const btn = document.getElementById('split-btn');
      const icon = document.getElementById('split-btn-icon');
      const text = document.getElementById('split-btn-text');
      btn.disabled = true;
      icon.innerHTML = '<div class="spinner"></div>';
      text.textContent = 'SPLITTING...';

      const colIdx = parseInt(document.getElementById('column-select').value);
      const profileId = document.getElementById('profile-select').value;
      const profile = profiles.find(p => p.id === profileId);
      const keepNonMatching = document.getElementById('keep-nonmatching').checked;
      const customPfx = document.getElementById('custom-prefix-toggle').checked ? document.getElementById('custom-prefix').value.trim() : '';
      const parameters = profile ? profile.parameters : [];

      showLog(); clearLog();

      const toProcess = queue.filter(q => q.selected && (q.status === 'ready' || q.status === 'waiting'));
      log('head', `Processing ${toProcess.length} file${toProcess.length !== 1 ? 's' : ''}...`);

      let totalCreated = 0;

      for (const item of toProcess) {
        item.status = 'processing';
        renderQueueItem(item);

        const effectiveOutput = outputDir || item.path.replace(/[\\/][^\\/]+$/, '');
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        const displayBase = customPfx || item.name.replace(/\.[^.]+$/, '');

        log('msg', `‚Üí ${item.name}`);
        log('msg', `  Format: ${dateStr}_${displayBase}_[REGION].xlsx`);

        const result = await window.splitify.splitFile({
          filePath: item.path,
          columnIndex: colIdx,
          parameters,
          outputDir: effectiveOutput,
          keepNonMatching,
          outputPrefix: customPfx
        });

        if (result.error) {
          item.status = 'error';
          item.errorMsg = result.error;
          log('err', `  ‚úó Error: ${result.error}`);
        } else {
          item.status = 'done';
          result.created.forEach(f => {
            const ccList = f.costCenters && f.costCenters.length ? ` [${f.costCenters.join(', ')}]` : '';
            log('ok', `  ‚úì ${f.file} (${f.rows} rows${ccList})`);
          });
          if (result.skipped.length) log('warn', `  Skipped: ${result.skipped.join(', ')}`);
          totalCreated += result.created.length;

          // Add open folder button for first done file
          if (totalCreated === result.created.length) {
            const bar = document.createElement('div');
            bar.className = 'log-result-bar';
            bar.innerHTML = `<span>‚úì ${totalCreated} file${totalCreated !== 1 ? 's' : ''} created</span>
          <button class="btn btn-accent" style="font-size:11px;padding:4px 10px" id="open-folder-btn">Open Folder ‚Üó</button>`;
            document.getElementById('log-area').appendChild(bar);
            document.getElementById('open-folder-btn').addEventListener('click', () => {
              window.splitify.openFolder(effectiveOutput);
            });
          }
        }
        renderQueueItem(item);
      }

      isProcessing = false;
      icon.textContent = '‚ñ∂';
      text.textContent = 'SPLIT SELECTED FILES';

      // Save to history
      const doneItems = queue.filter(q => q.status === 'done');
      if (doneItems.length > 0) {
        const profileId   = document.getElementById('profile-select').value;
        const profileName = profiles.find(p => p.id === profileId)?.name || '‚Äî no profile ‚Äî';
        const outputDir   = document.getElementById('output-path-display').textContent === 'Same folder as each input file'
          ? doneItems[0].path.substring(0, doneItems[0].path.replace(/\\/g, '/').lastIndexOf('/'))
          : document.getElementById('output-path-display').textContent;
        const entry = {
          id: 'h_' + Date.now(),
          timestamp: new Date().toISOString(),
          profileName,
          files: doneItems.map(q => ({ name: q.name, path: q.path, rows: q.totalRows || 0 })),
          outputDir,
          totalCreated
        };
        window.splitify.addHistoryEntry(entry).then(() => renderHistory());
      }
      updateSplitBtn();
      updateSelectAll();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showLog() { document.getElementById('log-area').classList.add('visible'); }
    function clearLog() { document.getElementById('log-area').innerHTML = ''; }
    function log(type, msg) {
      const area = document.getElementById('log-area');
      const now = new Date();
      const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
      const cls = { ok: 'log-ok', err: 'log-err', warn: 'log-warn', head: 'log-head', msg: '' }[type] || '';
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${escHtml(msg)}</span>`;
      area.appendChild(line);
      area.scrollTop = area.scrollHeight;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PROFILES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderProfileList() {
      const list = document.getElementById('profile-list');
      if (!profiles.length) {
        list.innerHTML = `<div class="empty-state"><div class="es-icon">‚óà</div><div class="es-text">No profiles yet.<br>Create one to get started.</div></div>`;
        return;
      }
      list.innerHTML = profiles.map(p => {
        const inc = p.parameters.filter(x => x.payable).length;
        const exc = p.parameters.filter(x => !x.payable).length;
        return `<div class="profile-item" data-id="${p.id}">
      <div class="profile-dot"></div>
      <div class="profile-info">
        <div class="profile-name">${escHtml(p.name)}</div>
        <div class="profile-meta">${inc} included ¬∑ ${exc} excluded ¬∑ ${p.parameters.length} total</div>
      </div>
      <div class="profile-actions">
        <button class="btn btn-ghost" style="font-size:11px;padding:4px 8px" onclick="editProfile('${p.id}')">Edit</button>
        <button class="btn btn-danger" style="font-size:11px;padding:4px 8px" onclick="confirmDeleteProfile('${p.id}',event)">Delete</button>
      </div>
    </div>`;
      }).join('');
      list.querySelectorAll('.profile-item').forEach(el => {
        el.addEventListener('click', e => { if (e.target.closest('.profile-actions')) return; editProfile(el.dataset.id); });
      });
    }

    function editProfile(id) {
      const profile = profiles.find(p => p.id === id);
      if (!profile) return;
      editingProfileId = id;
      editingParams = JSON.parse(JSON.stringify(profile.parameters));
      document.getElementById('editor-title').textContent = 'Edit Profile';
      document.getElementById('editor-name').value = profile.name;
      document.getElementById('editor-desc').value = profile.description || '';
      document.getElementById('editor-delete-btn').style.display = '';
      renderParamList();
      openEditor();
      renderProfileList();
    }

    function newProfile() {
      editingProfileId = null;
      editingParams = [];
      document.getElementById('editor-title').textContent = 'New Profile';
      document.getElementById('editor-name').value = '';
      document.getElementById('editor-desc').value = '';
      document.getElementById('editor-delete-btn').style.display = 'none';
      renderParamList();
      openEditor();
    }

    function openEditor() {
      document.getElementById('editor-modal-overlay').classList.add('open');
      setTimeout(() => document.getElementById('editor-name').focus(), 60);
    }
    function closeEditor() {
      document.getElementById('editor-modal-overlay').classList.remove('open');
      editingProfileId = null;
      renderProfileList();
    }

    function renderParamList() {
      const list = document.getElementById('param-list');
      document.getElementById('param-count').textContent = editingParams.length ? `(${editingParams.length})` : '';
      if (!editingParams.length) {
        list.innerHTML = `<div style="padding:10px;font-size:12px;color:var(--text3);text-align:center;font-weight:400">No parameters yet</div>`;
        return;
      }
      list.innerHTML = editingParams.map((p, i) => `
    <div class="param-row">
      <div class="param-value">${escHtml(p.value)}</div>
      <div class="param-label">${escHtml(p.label || '')}</div>
      <div class="param-badge ${p.payable ? 'incl' : 'excl'}" data-idx="${i}">${p.payable ? 'INCLUDED' : 'EXCLUDE'}</div>
      <button class="param-del" data-idx="${i}">√ó</button>
    </div>`).join('');

      list.querySelectorAll('.param-badge').forEach(el => {
        el.addEventListener('click', () => { editingParams[parseInt(el.dataset.idx)].payable = !editingParams[parseInt(el.dataset.idx)].payable; renderParamList(); });
      });
      list.querySelectorAll('.param-del').forEach(el => {
        el.addEventListener('click', () => { editingParams.splice(parseInt(el.dataset.idx), 1); renderParamList(); });
      });
    }

    document.getElementById('add-param-btn').addEventListener('click', addParam);
    document.getElementById('new-param-value').addEventListener('keydown', e => { if (e.key === 'Enter') addParam(); });

    function addParam() {
      const v = document.getElementById('new-param-value');
      const l = document.getElementById('new-param-label');
      const p = document.getElementById('new-param-payable');
      if (!v.value.trim()) { v.focus(); return; }
      editingParams.push({ value: v.value.trim(), label: l.value.trim(), payable: p.value === '1' });
      v.value = ''; l.value = ''; v.focus();
      renderParamList();
    }

    document.getElementById('editor-save-btn').addEventListener('click', saveProfile);
    function saveProfile() {
      const name = document.getElementById('editor-name').value.trim();
      if (!name) { document.getElementById('editor-name').focus(); return; }
      if (editingProfileId) {
        const idx = profiles.findIndex(p => p.id === editingProfileId);
        if (idx !== -1) profiles[idx] = { ...profiles[idx], name, description: document.getElementById('editor-desc').value.trim(), parameters: editingParams };
      } else {
        profiles.push({ id: 'p_' + Date.now(), name, description: document.getElementById('editor-desc').value.trim(), parameters: editingParams, createdAt: new Date().toISOString() });
      }
      window.splitify.saveProfiles(profiles);
      populateProfileSelect();
      recomputeAllPreviews();
      closeEditor();
    }

    document.getElementById('editor-delete-btn').addEventListener('click', () => { if (editingProfileId) confirmDeleteProfile(editingProfileId); });
    function confirmDeleteProfile(id, e) {
      if (e) e.stopPropagation();
      const p = profiles.find(x => x.id === id);
      if (!p || !confirm(`Delete profile "${p.name}"?`)) return;
      profiles = profiles.filter(x => x.id !== id);
      window.splitify.saveProfiles(profiles);
      if (editingProfileId === id) closeEditor();
      renderProfileList();
      populateProfileSelect();
    }

    document.getElementById('new-profile-btn').addEventListener('click', newProfile);
    document.getElementById('editor-close-btn').addEventListener('click', closeEditor);
    document.getElementById('editor-modal-overlay').addEventListener('click', e => { if (e.target === document.getElementById('editor-modal-overlay')) closeEditor(); });

    // ‚îÄ‚îÄ Import modal ‚îÄ‚îÄ
    document.getElementById('import-btn').addEventListener('click', () => { document.getElementById('import-textarea').value = ''; document.getElementById('modal-overlay').classList.add('open'); });
    document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal-overlay').classList.remove('open'));
    document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('modal-overlay').classList.remove('open'));
    document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === document.getElementById('modal-overlay')) document.getElementById('modal-overlay').classList.remove('open'); });
    document.getElementById('modal-import').addEventListener('click', () => {
      const lines = document.getElementById('import-textarea').value.split('\n').map(l => l.trim()).filter(Boolean);
      lines.forEach(line => {
        const excl = line.startsWith('!');
        const parts = (excl ? line.slice(1) : line).split(/[\t,]/).map(p => p.trim());
        if (parts[0]) editingParams.push({ value: parts[0], label: parts[1] || '', payable: !excl });
      });
      renderParamList();
      document.getElementById('modal-overlay').classList.remove('open');
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTO-UPDATER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (window.splitify && window.splitify.onAppVersion) {
      window.splitify.onAppVersion(v => {
        document.getElementById('app-version').textContent = 'v' + v;
      });
    }

    if (window.splitify && window.splitify.onUpdateAvailable) {
      window.splitify.onUpdateChecking && window.splitify.onUpdateChecking(() => {
        console.log('[updater] checking for updates...');
      });

      window.splitify.onUpdateAvailable(data => {
        const version = typeof data === 'object' ? data.version : data;
        const notes   = typeof data === 'object' ? data.notes   : null;
        console.log('[updater] update available:', version);
        document.getElementById('ub-text').textContent = `v${version} available ‚Äî downloading...`;
        document.getElementById('update-banner').classList.add('visible');
        if (notes) {
          const notesEl  = document.getElementById('ub-notes');
          const toggleEl = document.getElementById('ub-notes-toggle');
          notesEl.textContent = notes;
          toggleEl.style.display = '';
          toggleEl.addEventListener('click', () => {
            const open = notesEl.style.display !== 'none';
            notesEl.style.display = open ? 'none' : '';
            toggleEl.textContent = open ? "WHAT'S NEW ‚ñæ" : "WHAT'S NEW ‚ñ¥";
          });
        }
      });

      window.splitify.onUpdateNotAvailable && window.splitify.onUpdateNotAvailable(version => {
        console.log('[updater] up to date, current:', version);
      });

      window.splitify.onUpdateProgress(percent => {
        document.getElementById('ub-text').textContent = `Downloading update... ${percent}%`;
        document.getElementById('ub-progress-wrap').style.display = '';
        document.getElementById('ub-bar').style.width = percent + '%';
      });

      window.splitify.onUpdateDownloaded(() => {
        document.getElementById('ub-text').textContent = 'Update ready ‚Äî restart to install';
        document.getElementById('ub-progress-wrap').style.display = 'none';
        document.getElementById('ub-btn').style.display = '';
      });

      window.splitify.onUpdateError && window.splitify.onUpdateError(msg => {
        console.error('[updater] error:', msg);
        document.getElementById('ub-text').textContent = `Update check failed: ${msg}`;
        document.getElementById('update-banner').classList.add('visible');
        document.getElementById('update-banner').style.background = 'rgba(255,92,92,0.08)';
        document.getElementById('update-banner').style.borderBottomColor = 'rgba(255,92,92,0.2)';
        document.getElementById('ub-text').style.color = 'var(--red)';
      });

      document.getElementById('ub-btn').addEventListener('click', () => window.splitify.installUpdate());
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function escHtml(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SETTINGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let appSettings = {
      theme: 'dark',
      updateIntervalHours: 4,
      checkUpdatesOnStartup: true
    };

    async function loadAndApplySettings() {
      appSettings = await window.splitify.getSettings();
      applyTheme(appSettings.theme);

      document.getElementById('setting-startup-check').checked = appSettings.checkUpdatesOnStartup !== false;
      document.getElementById('setting-interval').value = appSettings.updateIntervalHours || 4;

      // Set theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === appSettings.theme);
      });

      // Populate favorite profile select
    }



    async function saveAppSettings() {
      await window.splitify.saveSettings(appSettings);
    }

    function applyTheme(theme) {
      document.body.classList.toggle('light', theme === 'light');
    }

    // Theme buttons
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        appSettings.theme = btn.dataset.theme;
        applyTheme(appSettings.theme);
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === appSettings.theme));
        saveAppSettings();
      });
    });

    // Startup check toggle
    document.getElementById('setting-startup-check').addEventListener('change', function () {
      appSettings.checkUpdatesOnStartup = this.checked;
      saveAppSettings();
    });

    // Interval select
    document.getElementById('setting-interval').addEventListener('change', function () {
      appSettings.updateIntervalHours = parseInt(this.value);
      saveAppSettings();
    });

    // Favorite profile


    // Check for updates button
    document.getElementById('check-updates-btn').addEventListener('click', async () => {
      const btn = document.getElementById('check-updates-btn');
      const statusRow = document.getElementById('update-status-row');
      const statusLabel = document.getElementById('update-status-label');

      btn.disabled = true;
      btn.textContent = 'Checking...';
      statusRow.style.display = '';
      statusLabel.textContent = 'Checking for updates...';
      statusLabel.style.color = 'var(--text3)';

      await window.splitify.checkForUpdates();

      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'Check Now';
      }, 3000);
    });

    // Feedback
    document.getElementById('feedback-email-btn').addEventListener('click', () => {
      const textEl = document.getElementById('feedback-text');
      const text = textEl.value.trim();
      const btn = document.getElementById('feedback-email-btn');

      if (!text) {
        // Shake the textarea to indicate it's required
        textEl.style.borderColor = 'var(--red)';
        textEl.setAttribute('placeholder', 'Please enter your feedback before sending...');
        textEl.focus();
        setTimeout(() => { textEl.style.borderColor = ''; }, 2000);
        return;
      }

      const version = document.getElementById('app-version')?.textContent || 'unknown';
      const subject = encodeURIComponent(`Splitify Feedback (${version})`);
      const body = encodeURIComponent(`${text}\n\n---\nSplitify ${version}`);
      window.splitify.openExternal(`mailto:nvasiljevic42@gmail.com?subject=${subject}&body=${body}`);

      // Show confirmation
      const originalText = btn.textContent;
      btn.textContent = '‚úì Email Client Opened';
      btn.style.background = 'rgba(120,232,96,0.25)';
      btn.style.borderColor = 'var(--accent2)';
      btn.style.color = 'var(--accent2)';
      textEl.value = '';

      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
        btn.style.borderColor = '';
        btn.style.color = '';
      }, 3000);
    });

    document.getElementById('feedback-github-btn').addEventListener('click', () => {
      const text = document.getElementById('feedback-text').value.trim();
      const title = encodeURIComponent('Feedback / Bug Report');
      const body = encodeURIComponent(text || '');
      window.splitify.openExternal(`https://github.com/vslnnd/Splitify/issues/new?title=${title}&body=${body}`);
    });

    document.getElementById('github-btn').addEventListener('click', () => {
      window.splitify.openExternal('https://github.com/vslnnd/Splitify');
    });

    // Update status in settings panel
    if (window.splitify && window.splitify.onUpdateChecking) {
      window.splitify.onUpdateChecking(() => {
        const el = document.getElementById('update-status-label');
        const row = document.getElementById('update-status-row');
        if (el) { el.textContent = 'Checking for updates...'; el.style.color = 'var(--text3)'; row.style.display = ''; }
      });
    }
    if (window.splitify && window.splitify.onUpdateNotAvailable) {
      window.splitify.onUpdateNotAvailable(() => {
        const el = document.getElementById('update-status-label');
        const row = document.getElementById('update-status-row');
        if (el) { el.textContent = '‚úì You are on the latest version'; el.style.color = 'var(--accent2)'; row.style.display = ''; }
      });
    }

    // Show settings version label
    if (window.splitify && window.splitify.onAppVersion) {
      window.splitify.onAppVersion(v => {
        const el = document.getElementById('settings-version');
        if (el) el.textContent = 'v' + v;
      });
    }

    // Init settings after profiles load
    loadAndApplySettings();


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PROFILES IMPORT / EXPORT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('export-profiles-btn').addEventListener('click', async () => {
      const data = JSON.stringify(profiles, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      a.href = url;
      a.download = `splitify_profiles_${date}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('import-profiles-btn').addEventListener('click', () => {
      document.getElementById('import-profiles-input').click();
    });

    document.getElementById('import-profiles-input').addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;
      const mode = document.getElementById('import-mode').value;

      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        if (!Array.isArray(imported)) { alert('Invalid profiles file.'); return; }

        if (mode === 'replace') {
          if (!confirm(`Replace all ${profiles.length} existing profiles with ${imported.length} imported profiles?`)) return;
          profiles = imported;
        } else {
          // Merge: skip profiles with same name
          let added = 0;
          imported.forEach(p => {
            if (!profiles.find(x => x.name === p.name)) {
              profiles.push({ ...p, id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4) });
              added++;
            }
          });
          alert(`Imported ${added} new profiles (${imported.length - added} skipped ‚Äî name already exists).`);
        }

        window.splitify.saveProfiles(profiles);
        renderProfileList();
        populateProfileSelect();
          this.value = '';
      } catch (e) {
        alert('Failed to read file: ' + e.message);
      }
    });


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  HISTORY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function renderHistory() {
      const history = await window.splitify.getHistory();
      const list = document.getElementById('history-list');
      const empty = document.getElementById('history-empty');
      const countEl = document.getElementById('history-count');

      if (!history || history.length === 0) {
        list.innerHTML = '';
        empty.style.display = '';
        countEl.textContent = 'No history';
        return;
      }

      empty.style.display = 'none';
      countEl.textContent = `${history.length} split${history.length !== 1 ? 's' : ''}`;

      list.innerHTML = history.map(entry => {
        const d = new Date(entry.timestamp);
        const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const fileNames = (entry.files || []).map(f => f.name).join(', ');
        const firstFile = entry.files && entry.files[0] ? entry.files[0].name : 'Unknown';
        return `<div class="history-item" data-id="${entry.id}">
          <div class="history-item-header" onclick="toggleHistory('${entry.id}')">
            <span class="history-chevron">‚ñ∂</span>
            <div class="history-item-title">
              <div class="history-item-name">${escHtml(firstFile)}${entry.files && entry.files.length > 1 ? ` +${entry.files.length - 1} more` : ''}</div>
              <div class="history-item-meta">${dateStr} ¬∑ ${escHtml(entry.profileName)} ¬∑ ${entry.totalCreated || 0} output files</div>
            </div>
          </div>
          <div class="history-item-body">
            <div class="history-files">${(entry.files || []).map(f => `<span class="history-file-pill">${escHtml(f.name)}</span>`).join('')}</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn btn-accent history-rerun-btn" onclick="rerunHistory('${entry.id}')">‚ñ∂ Re-run</button>
              <button class="btn btn-ghost history-rerun-btn" onclick="openHistoryFolder('${entry.id}')">Open Folder ‚Üó</button>
              <span style="font-size:10px;color:var(--text3);margin-left:auto">${escHtml(entry.outputDir || '')}</span>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function toggleHistory(id) {
      const el = document.querySelector(`.history-item[data-id="${id}"]`);
      if (el) el.classList.toggle('open');
    }

    async function openHistoryFolder(id) {
      const history = await window.splitify.getHistory();
      const entry = history.find(h => h.id === id);
      if (entry && entry.outputDir) window.splitify.openFolder(entry.outputDir);
    }

    async function rerunHistory(id) {
      const history = await window.splitify.getHistory();
      const entry = history.find(h => h.id === id);
      if (!entry) return;

      // Switch to Split tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-tab="split"]').classList.add('active');
      document.getElementById('tab-split').classList.add('active');

      // Add files back to queue
      for (const f of (entry.files || [])) {
        await addToQueue(f.path);
      }

      // Re-select profile
      const prof = profiles.find(p => p.name === entry.profileName);
      if (prof) {
        document.getElementById('profile-select').value = prof.id;
        recomputeAllPreviews();
      }
    }

    document.getElementById('clear-history-btn').addEventListener('click', async () => {
      if (!confirm('Clear all split history?')) return;
      await window.splitify.clearHistory();
      renderHistory();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TUTORIAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const TUTORIAL_STEPS = [
      {
        title: 'Drop your files',
        body: 'Drag and drop one or more Excel files onto the drop zone, or click it to browse. You can add multiple files at once.',
        targetId: 'drop-zone',
        tab: 'split'
      },
      {
        title: 'Pick a split column',
        body: 'After uploading, choose which column to split by ‚Äî usually "Cost Center Ref." The app will auto-detect it if it finds a matching column name.',
        targetId: 'section-settings',
        tab: 'split',
        showQueue: true
      },
      {
        title: 'Choose a profile',
        body: 'Profiles define how values map to output files. If your file has a "Client" column matching a profile name, it's auto-selected. Otherwise pick one manually.',
        targetId: 'section-settings',
        tab: 'split',
        showQueue: true
      },
      {
        title: 'Split!',
        body: 'Hit the SPLIT button at the bottom. Each file in the queue gets split into separate output files per region. Results appear in the log below.',
        targetId: 'split-bottom',
        tab: 'split',
        showQueue: true
      }
    ];

    let tutorialStep = 0;

    function startTutorial() {
      tutorialStep = 0;
      document.getElementById('tutorial-overlay').style.display = '';
      showTutorialStep(tutorialStep);
    }

    function showTutorialStep(step) {
      const s = TUTORIAL_STEPS[step];

      // Switch tab if needed
      if (s.tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelector(`[data-tab="${s.tab}"]`).classList.add('active');
        document.getElementById(`tab-${s.tab}`).classList.add('active');
      }

      document.getElementById('tutorial-step-indicator').textContent = `Step ${step + 1} of ${TUTORIAL_STEPS.length}`;
      document.getElementById('tutorial-title').textContent = s.title;
      document.getElementById('tutorial-body').textContent = s.body;
      document.getElementById('tutorial-next-btn').textContent = step === TUTORIAL_STEPS.length - 1 ? 'Finish ‚úì' : 'Next ‚Üí';

      // Position spotlight on target
      setTimeout(() => {
        const target = document.getElementById(s.targetId);
        if (target) {
          const r = target.getBoundingClientRect();
          const pad = 8;
          const spot = document.getElementById('tutorial-spotlight');
          spot.style.left   = (r.left - pad) + 'px';
          spot.style.top    = (r.top - pad) + 'px';
          spot.style.width  = (r.width + pad * 2) + 'px';
          spot.style.height = (r.height + pad * 2) + 'px';
          spot.style.display = '';
        }
      }, 50);
    }

    function closeTutorial() {
      document.getElementById('tutorial-overlay').style.display = 'none';
      document.getElementById('tutorial-spotlight').style.display = 'none';
      window.splitify.markTutorialShown();
    }

    document.getElementById('tutorial-next-btn').addEventListener('click', () => {
      if (tutorialStep < TUTORIAL_STEPS.length - 1) {
        tutorialStep++;
        showTutorialStep(tutorialStep);
      } else {
        closeTutorial();
      }
    });
    document.getElementById('tutorial-skip-btn').addEventListener('click', closeTutorial);

    document.getElementById('show-tutorial-btn').addEventListener('click', startTutorial);

    if (window.splitify && window.splitify.onShowTutorial) {
      window.splitify.onShowTutorial(() => startTutorial());
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  WHAT'S NEW MODAL (first launch after update)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (window.splitify && window.splitify.onFirstLaunchAfterUpdate) {
      window.splitify.onFirstLaunchAfterUpdate(async (version) => {
        // Fetch notes from GitHub releases API
        try {
          const resp = await fetch(`https://api.github.com/repos/vslnnd/Splitify/releases/tags/v${version}`);
          const data = await resp.json();
          const notes = data.body || 'No patch notes available for this version.';
          document.getElementById('whatsnew-version').textContent = `Version ${version}`;
          document.getElementById('whatsnew-notes').textContent = notes;
          document.getElementById('whatsnew-overlay').style.display = 'flex';
        } catch(e) {
          // If can't fetch, show basic modal
          document.getElementById('whatsnew-version').textContent = `Version ${version}`;
          document.getElementById('whatsnew-notes').textContent = 'Updated to the latest version.';
          document.getElementById('whatsnew-overlay').style.display = 'flex';
        }
      });
    }
    document.getElementById('whatsnew-close').addEventListener('click',     () => { document.getElementById('whatsnew-overlay').style.display = 'none'; });
    document.getElementById('whatsnew-close-btn').addEventListener('click', () => { document.getElementById('whatsnew-overlay').style.display = 'none'; });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CHANGELOG MODAL (? button)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('changelog-btn').addEventListener('click', async () => {
      document.getElementById('changelog-overlay').style.display = 'flex';
      const body = document.getElementById('changelog-body');
      body.innerHTML = '<div id="changelog-loading" style="text-align:center;padding:24px;color:var(--text3);font-size:12px">Loading release history...</div>';
      try {
        const resp = await fetch('https://api.github.com/repos/vslnnd/Splitify/releases');
        const releases = await resp.json();
        if (!Array.isArray(releases) || releases.length === 0) {
          body.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--text3);text-align:center">No releases found.</div>';
          return;
        }
        body.innerHTML = releases.map(r => {
          const d = new Date(r.published_at);
          const dateStr = d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
          const notes = r.body ? escHtml(r.body) : '<span style="color:var(--text3);font-style:italic">No notes for this release</span>';
          return `<div class="changelog-entry">
            <div class="changelog-version">${escHtml(r.tag_name)}</div>
            <div class="changelog-date">${dateStr}</div>
            <div class="changelog-notes">${notes}</div>
          </div>`;
        }).join('');
      } catch(e) {
        body.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--red)">Could not load releases. Check your internet connection.</div>';
      }
    });
    document.getElementById('changelog-close').addEventListener('click', () => { document.getElementById('changelog-overlay').style.display = 'none'; });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT ‚Äî load history on startup
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    renderHistory();

  </script>
</body>

</html>